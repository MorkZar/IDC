stages:
  - build
  - test
  - deploy

# Etapa de build: compilar dependencias PHP
build-job:
  stage: build
  image: composer:2
  script:
    - echo "Instalando dependencias..."
    - composer install
    - echo "Build completo."

# Etapa de test: pruebas unitarias
unit-test-job:
  stage: test
  image: php:8.2
  script:
    - echo "Ejecutando pruebas unitarias..."
    # php vendor/bin/phpunit tests --log-junit report.xml
    - echo "Pruebas completadas."

lint-test-job:
  stage: test
  image: php:8.2
  script:
    - echo "Linting code..."
    - php -l iniicioSesion1.php
    - echo "Lint OK."

# Etapa de deploy: construir y levantar contenedores Docker
deploy-job:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - echo "Construyendo imagen Docker..."
    - docker build -t idc-app:latest .
    - echo "Levantando contenedores con docker-compose..."
    - docker-compose up -d --build
  environment:
    name: production


